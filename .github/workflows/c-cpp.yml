name: C/C++ CI

on:
  pull_request:
    types: [ opened, edited, synchronize, reopened ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: TICS Action Setup
      uses: actions/checkout@v2
      with:
        repository: tiobetestlab/.github
        path: ./.github
    
    - name: make all
      run: make all
    
    - name: Retrieve TICS Wrappers
      run: source <(curl -s "https://testlab.tiobe.com/tiobeweb/testlab/api/private/fapi/installtics/Script?cfg=testlab&platform=linux&url=https://testlab.tiobe.com/tiobeweb/testlab&usersettings=false")
      
    - name: TICS without plugin
      env: 
        TICS: 'https://testlab.tiobe.com/tiobeweb/testlab/api/cfg?name=testlab'
      run: /home/runner/TICSWrapper/BuildServer/TICS -calc CW -changed -project c-demo -cdtoken c-demo .
      
    - name: TICS Action Run
      uses: ./.github/actions/tics
      env: 
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        TICS: https://testlab.tiobe.com/tiobeweb/testlab/api/cfg?name=testlab
        PATH: $PATH:/home/runner/TICSWrapper/BuildServer
      with:
        projectName: 'c-demo'
        branchName: 'main'
        ticsViewerUrl: 'https://testlab.tiobe.com/tiobeweb/testlab/'
        ticsAuthToken: 'NGUyOTFkMzMtM2ExYS00MDhjLTgzMDktMTVlNjBlYjZmMzM5OnBTWiVNUl5FZmdSLTpwQg'
        clientToken: 'c-demo'
        tmpDir: '\tmp\c-demo'
        calc: 'CW,CS,FANOUT,CY,DUP'

